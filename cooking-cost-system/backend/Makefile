# ================================
# æ–™ç†åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  - Makefile
# ================================

.PHONY: help install build start dev test lint clean docker-build docker-run deploy

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help

# ç’°å¢ƒå¤‰æ•°
NODE_ENV ?= development
PORT ?= 3001
DOCKER_IMAGE_NAME = cooking-cost-backend
DOCKER_TAG ?= latest
REGISTRY ?= ghcr.io/cooking-cost-system

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "æ–™ç†åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰"
	@echo "=================================="
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ================================
# é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ================================

install: ## ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	npm ci
	@echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

install-dev: ## é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	@echo "ğŸ“¦ é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	npm install
	@echo "âœ… é–‹ç™ºç”¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

setup: install ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "ğŸ”§ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
	cp .env.example .env
	mkdir -p logs uploads
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

# ================================
# ãƒ“ãƒ«ãƒ‰
# ================================

build: ## TypeScriptã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ ãƒ“ãƒ«ãƒ‰ä¸­..."
	npm run build
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-clean: clean build ## ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰å®Œäº†"

typecheck: ## å‹ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ” å‹ãƒã‚§ãƒƒã‚¯ä¸­..."
	npm run typecheck
	@echo "âœ… å‹ãƒã‚§ãƒƒã‚¯å®Œäº†"

# ================================
# å®Ÿè¡Œ
# ================================

start: build ## æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
	@echo "ğŸš€ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­..."
	NODE_ENV=production npm start

dev: ## é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
	@echo "ğŸš€ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­..."
	npm run dev

dev-debug: ## ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
	@echo "ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­..."
	NODE_ENV=development DEBUG=* npm run dev

# ================================
# ãƒ†ã‚¹ãƒˆ
# ================================

test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npm test

test-watch: ## ãƒ†ã‚¹ãƒˆã‚’ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
	@echo "ğŸ‘€ ãƒ†ã‚¹ãƒˆç›£è¦–ãƒ¢ãƒ¼ãƒ‰..."
	npm run test:watch

test-coverage: ## ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npm run test:coverage

test-integration: ## çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npm run test:integration

test-e2e: ## E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ¯ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npm run test:e2e

# ================================
# ã‚³ãƒ¼ãƒ‰å“è³ª
# ================================

lint: ## ãƒªãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè¡Œ
	@echo "ğŸ” ãƒªãƒ³ã‚¿ãƒ¼å®Ÿè¡Œä¸­..."
	npm run lint

lint-fix: ## ãƒªãƒ³ã‚¿ãƒ¼ã§ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’è‡ªå‹•ä¿®æ­£
	@echo "ğŸ”§ ãƒªãƒ³ã‚¿ãƒ¼è‡ªå‹•ä¿®æ­£ä¸­..."
	npm run lint:fix

format: ## ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	@echo "âœ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	npx prettier --write "src/**/*.{ts,js,json}"

audit: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
	@echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ä¸­..."
	npm audit --audit-level=moderate

audit-fix: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®è‡ªå‹•ä¿®æ­£
	@echo "ğŸ”§ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œä¿®æ­£ä¸­..."
	npm audit fix

# ================================
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
# ================================

db-create: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ
	@echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆä¸­..."
	mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS cooking_cost_system;"
	mysql -u root -p -e "CREATE USER IF NOT EXISTS 'cooking_user'@'localhost' IDENTIFIED BY 'cooking_password';"
	mysql -u root -p -e "GRANT ALL PRIVILEGES ON cooking_cost_system.* TO 'cooking_user'@'localhost';"
	mysql -u root -p -e "FLUSH PRIVILEGES;"

db-migrate: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
	@echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­..."
	mysql -u cooking_user -pcooking_password cooking_cost_system < database/init/01_create_tables.sql

db-seed: ## ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
	@echo "ğŸŒ± ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­..."
	mysql -u cooking_user -pcooking_password cooking_cost_system < database/init/02_sample_data.sql

db-reset: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
	@echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆä¸­..."
	mysql -u root -p -e "DROP DATABASE IF EXISTS cooking_cost_system;"
	$(MAKE) db-create db-migrate db-seed

db-backup: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
	@echo "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
	mkdir -p backups
	mysqldump -u cooking_user -pcooking_password cooking_cost_system > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: backups/backup_$(shell date +%Y%m%d_%H%M%S).sql"

# ================================
# Docker
# ================================

docker-build: ## Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ä¸­..."
	docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
	@echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Œäº†"

docker-build-dev: ## é–‹ç™ºç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ³ é–‹ç™ºç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ä¸­..."
	docker build -f Dockerfile.dev -t $(DOCKER_IMAGE_NAME):dev .

docker-run: ## Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
	@echo "ğŸ³ Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
	docker run -p $(PORT):$(PORT) --env-file .env $(DOCKER_IMAGE_NAME):$(DOCKER_TAG)

docker-run-dev: ## é–‹ç™ºç”¨Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
	@echo "ğŸ³ é–‹ç™ºç”¨Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
	docker run -it -p $(PORT):$(PORT) -v $(PWD):/app --env-file .env $(DOCKER_IMAGE_NAME):dev

docker-compose-up: ## Docker Composeã§èµ·å‹•
	@echo "ğŸ³ Docker Composeèµ·å‹•ä¸­..."
	docker-compose up --build

docker-compose-dev: ## é–‹ç™ºç”¨Docker Composeã§èµ·å‹•
	@echo "ğŸ³ é–‹ç™ºç”¨Docker Composeèµ·å‹•ä¸­..."
	docker-compose -f docker-compose.yml up backend-dev

docker-compose-down: ## Docker Composeã‚’åœæ­¢
	@echo "ğŸ³ Docker Composeåœæ­¢ä¸­..."
	docker-compose down

docker-push: docker-build ## Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
	@echo "ğŸ“¤ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
	docker tag $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) $(REGISTRY)/$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)
	docker push $(REGISTRY)/$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)

# ================================
# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ================================

clean: ## ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	rm -rf dist/
	rm -rf coverage/
	rm -rf .nyc_output/
	rm -rf node_modules/.cache/
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

clean-all: clean ## å…¨ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	@echo "ğŸ§¹ å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	rm -rf node_modules/
	rm -rf logs/
	rm -rf uploads/
	rm -rf backups/
	@echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

clean-docker: ## Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
	@echo "ğŸ³ Dockerã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	docker system prune -f
	docker volume prune -f
	docker network prune -f

# ================================
# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
# ================================

deploy-staging: ## ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	kubectl apply -f deploy/kubernetes.yaml --namespace=cooking-cost-staging
	kubectl rollout status deployment/cooking-cost-backend --namespace=cooking-cost-staging

deploy-production: ## æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	kubectl apply -f deploy/kubernetes.yaml --namespace=cooking-cost-production
	kubectl rollout status deployment/cooking-cost-backend --namespace=cooking-cost-production

rollback-staging: ## ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
	@echo "âª ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­..."
	kubectl rollout undo deployment/cooking-cost-backend --namespace=cooking-cost-staging

rollback-production: ## æœ¬ç•ªç’°å¢ƒã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
	@echo "âª æœ¬ç•ªç’°å¢ƒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­..."
	kubectl rollout undo deployment/cooking-cost-backend --namespace=cooking-cost-production

# ================================
# ç›£è¦–ãƒ»ãƒ­ã‚°
# ================================

logs: ## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ ãƒ­ã‚°è¡¨ç¤ºä¸­..."
	tail -f logs/combined-*.log

logs-error: ## ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºä¸­..."
	tail -f logs/error-*.log

logs-docker: ## Dockerã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ³ Dockerãƒ­ã‚°è¡¨ç¤ºä¸­..."
	docker logs -f cooking_cost_backend_dev

status: ## ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
	@echo "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
	@echo "Node.js version: $(shell node --version)"
	@echo "NPM version: $(shell npm --version)"
	@echo "TypeScript version: $(shell npx tsc --version)"
	@echo "Docker version: $(shell docker --version 2>/dev/null || echo 'Docker not installed')"
	@echo "Kubectl version: $(shell kubectl version --client --short 2>/dev/null || echo 'kubectl not installed')"

health-check: ## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
	@echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
	curl -f http://localhost:$(PORT)/health || echo "ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"

# ================================
# é–‹ç™ºãƒ„ãƒ¼ãƒ«
# ================================

update-deps: ## ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚æ›´æ–°ä¸­..."
	npm update
	npm audit fix --force

check-deps: ## ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ” ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ä¸­..."
	npm audit
	npx npm-check-updates

generate-docs: ## APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
	@echo "ğŸ“š APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆä¸­..."
	npx typedoc src/ --out docs/api/

benchmark: ## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npx clinic doctor -- node dist/server.js &
	sleep 5
	curl -X GET http://localhost:$(PORT)/api/ingredients
	pkill -f "node dist/server.js"

# ================================
# ç’°å¢ƒåˆ¥ã‚³ãƒãƒ³ãƒ‰
# ================================

dev-full: ## å®Œå…¨ãªé–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ï¼ˆDBå«ã‚€ï¼‰
	@echo "ğŸš€ å®Œå…¨ãªé–‹ç™ºç’°å¢ƒèµ·å‹•ä¸­..."
	$(MAKE) docker-compose-dev

production-build: ## æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ­ æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ä¸­..."
	NODE_ENV=production npm run build
	npm prune --production

staging-deploy: test lint docker-build deploy-staging ## ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

production-deploy: test lint docker-build deploy-production ## æœ¬ç•ªç’°å¢ƒã¸ã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "âœ… æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ================================
# CI/CDé–¢é€£
# ================================

ci-test: ## CIç”¨ãƒ†ã‚¹ãƒˆï¼ˆè»½é‡ç‰ˆï¼‰
	@echo "ğŸ§ª CIç”¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	npm run lint
	npm run typecheck
	npm run test -- --ci --coverage --watchAll=false

ci-build: ## CIç”¨ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ CIç”¨ãƒ“ãƒ«ãƒ‰ä¸­..."
	NODE_ENV=production npm run build

ci-security: ## CIç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ”’ CIç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­..."
	npm audit --audit-level=high
	npx snyk test

# ================================
# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# ================================

port-check: ## ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ” ãƒãƒ¼ãƒˆ$(PORT)ã®ä½¿ç”¨çŠ¶æ³:"
	@lsof -i :$(PORT) || echo "ãƒãƒ¼ãƒˆ$(PORT)ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“"

kill-port: ## æŒ‡å®šãƒãƒ¼ãƒˆã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
	@echo "ğŸ’€ ãƒãƒ¼ãƒˆ$(PORT)ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ä¸­..."
	@lsof -ti:$(PORT) | xargs kill -9 || echo "ãƒãƒ¼ãƒˆ$(PORT)ã«ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

env-check: ## ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ” ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
	@echo "NODE_ENV: $(NODE_ENV)"
	@echo "PORT: $(PORT)"
	@echo "DB_HOST: $${DB_HOST:-æœªè¨­å®š}"
	@echo "DB_NAME: $${DB_NAME:-æœªè¨­å®š}"

backup-rotate: ## å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
	@echo "ğŸ—‘ï¸ å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤ä¸­..."
	find backups/ -name "*.sql" -mtime +30 -delete 2>/dev/null || true

# ================================
# ç‰¹æ®Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
# ================================

version: ## ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
	@echo "æ–™ç†åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  v2.0.0"
	@echo "Node.js: $(shell node --version)"
	@echo "NPM: $(shell npm --version)"

quick-start: setup db-create db-migrate db-seed dev ## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆåˆå›ç”¨ï¼‰
	@echo "ğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆå®Œäº†ï¼"
	@echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:$(PORT) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"
