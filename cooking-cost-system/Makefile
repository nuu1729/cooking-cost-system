# cooking-cost-system/Makefile
# æ–™ç†åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  v2.0 ã‚¿ã‚¹ã‚¯è‡ªå‹•åŒ–

.PHONY: help dev build test clean logs backend-shell db-shell frontend-shell stop restart

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "ğŸ½ï¸ æ–™ç†åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  v2.0"
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# é–‹ç™ºç’°å¢ƒ
dev: ## é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•
	@echo "ğŸš€ é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
	docker-compose up -d
	@echo "âœ… èµ·å‹•å®Œäº†ï¼"
	@echo "ğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000"
	@echo "ğŸ”§ API: http://localhost:3001"
	@echo "ğŸ—„ï¸ phpMyAdmin: http://localhost:8080"

# æœ¬ç•ªç’°å¢ƒ
prod: ## æœ¬ç•ªç’°å¢ƒã‚’èµ·å‹•
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
	docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… èµ·å‹•å®Œäº†ï¼"

# ãƒ“ãƒ«ãƒ‰
build: ## ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™..."
	docker-compose build
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	docker-compose exec backend npm test
	docker-compose exec frontend npm test
	@echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼"

# ãƒ­ã‚°è¡¨ç¤º
logs: ## ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker-compose logs -f

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°
backend-logs: ## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker-compose logs -f backend

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°
frontend-logs: ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker-compose logs -f frontend

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°
db-logs: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker-compose logs -f database

# ã‚·ã‚§ãƒ«æ¥ç¶š
backend-shell: ## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶š
	docker-compose exec backend sh

frontend-shell: ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶š
	docker-compose exec frontend sh

db-shell: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
	docker-compose exec database mysql -u cooking_user -p cooking_cost_system

# åœæ­¢ãƒ»å†èµ·å‹•
stop: ## ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
	@echo "â¹ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."
	docker-compose down
	@echo "âœ… åœæ­¢å®Œäº†ï¼"

restart: ## ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•
	@echo "ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¦ã„ã¾ã™..."
	docker-compose restart
	@echo "âœ… å†èµ·å‹•å®Œäº†ï¼"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: ## ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
	docker-compose down -v
	docker system prune -f
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ï¼"

# ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
reset-db: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
	@echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™..."
	docker-compose down
	docker volume rm cooking-cost-system_db_data || true
	docker-compose up -d database
	@echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
	@echo "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
	mkdir -p backups
	docker-compose exec database mysqldump -u cooking_user -pcooking_password cooking_cost_system > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼"

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install: ## åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "ğŸ› ï¸ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	cp .env.example .env || true
	cp backend/.env.example backend/.env || true  
	cp frontend/.env.example frontend/.env || true
	docker-compose build
	docker-compose up -d
	@echo "â³ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­..."
	sleep 30
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
	@echo "ğŸ“± http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"

# ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
update: ## ã‚·ã‚¹ãƒ†ãƒ ã‚’æ›´æ–°
	@echo "ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™..."
	git pull origin main
	docker-compose build
	docker-compose up -d
	@echo "âœ… æ›´æ–°å®Œäº†ï¼"

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
status: ## ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹:"
	docker-compose ps

# çµ±è¨ˆæƒ…å ±
stats: ## ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã‚’è¡¨ç¤º
	@echo "ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ:"
	docker stats --no-stream

# é–‹ç™ºç”¨ - ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
dev-watch: ## é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ï¼‰
	docker-compose -f docker-compose.yml up --build

# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
deploy-prep: ## æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
	@echo "ğŸ“¦ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™..."
	docker-compose -f docker-compose.prod.yml build
	@echo "âœ… æº–å‚™å®Œäº†ï¼"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
security-scan: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
	@echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ..."
	docker run --rm -v $(PWD):/app securecodewarrior/docker-security-scan /app

# ä¾å­˜é–¢ä¿‚æ›´æ–°
update-deps: ## ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°..."
	docker-compose exec backend npm update
	docker-compose exec frontend npm update
	@echo "âœ… æ›´æ–°å®Œäº†ï¼"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
perf-test: ## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ..."
	docker-compose exec frontend npm run build
	@echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†ï¼"

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
docs: ## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
	@echo "ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ..."
	docker-compose exec backend npm run docs || true
	docker-compose exec frontend npm run docs || true